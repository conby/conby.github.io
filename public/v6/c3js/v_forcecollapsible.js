function updateVtypeChange(t){json_source=JSON.parse(t),svg.selectAll("*").remove(),root=json_source,root.fixed=!0,root.x=w/2,root.y=h/2+30,update3()}function update3(){var t=flatten(root),n=d3.layout.tree().links(t);force.nodes(t).links(n).start(),link=svg.selectAll("line.link").data(n,function(t){return t.target.id}),link.enter().insert("svg:line",".node").attr("class","link").attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),link.exit().remove(),node=svg.selectAll("circle.node").data(t,function(t){return t.id}).style("fill",color),node.transition().attr("r",function(t){return t.children?4.5:Math.sqrt(t.size)/10}),node.enter().append("svg:circle").attr("class","node").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.children?4.5:Math.sqrt(t.size)/10}).style("fill",function(t){return t._children?"#3182bd":t.children?"#c6dbef":"#fd8d3c"}).on("click",click3).call(force.drag),node.exit().remove()}function tick(){link.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),node.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}function color(t){return t._children?"#3182bd":t.children?"#c6dbef":"#fd8d3c"}function click3(t){t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),update3()}function flatten(t){function n(t){return t.children&&(t.size=t.children.reduce(function(t,r){return t+n(r)},0)),t.id||(t.id=++e),r.push(t),t.size}var r=[],e=0;return t.size=n(t),r}w=ow,h=oh,force=d3.layout.force().on("tick",tick).charge(function(t){return t._children?-t.size/100:-30}).linkDistance(function(t){return t.target._children?80:30}).size([w,h-160]),svg&&svg.remove(),svg=d3.select("#chat").append("svg:svg").attr("width",w).attr("height",h),json_source?(root=json_source,root.fixed=!0,root.x=w/2,root.y=h/2+30,update3()):d3.json(document.getElementById("jsonsource").value,function(t){root=t,root.fixed=!0,root.x=w/2,root.y=h/2+30,update3()});